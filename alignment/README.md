# Image Alignment Program

This repository contains a script written in Java that runs on ImageJ. The script performs alignment/registration of image stacks using the ImageJ StackReg and TurboReg plugins.

## Dependencies

* ImageJ
  * <https://imagej.net>

* TurboReg
  * <http://bigwww.epfl.ch/thevenaz/turboreg/>
  
* StackReg (for ImageAlignment.java)
  * <http://bigwww.epfl.ch/thevenaz/stackreg/>
  
* MultiStackReg (for ImageAlignmentPlus.java)
  * <http://bradbusse.net/downloads.html>

A copy of the TurboReg, StackReg, and MultiStackReg plugins can be found in the `imagej_plugins` folder.

TurboReg, StackReg, and MultiStackReg plugins are based on the following paper:

    P. Thévenaz, U. E. Ruttimann, and M. Unser,
    “A pyramid approach to subpixel registration based on intensity,” 
    IEEE Transactions on Image Processing, vol. 7, no. 1, pp. 27–41, 1998.

The paper can be found here: <http://bigwww.epfl.ch/publications/thevenaz9801.html>

## How to Use

The current implementations of the ImageAlignment.java and ImageAlignmentPlus.java programs use rigid-body motion (rotation and translation) combined with isometric scaling. The script must be run inside ImageJ. Once ImageJ is open click on *File > New > Script*. This will open the Script window. Click *File > Open* and locate the ImageAlignment.java or ImageAlignmentPlus.java file. From here you can click *Run* to begin execution.

During execution, an open dialog window will open asking for the location of the folder with the images. The program is designed to work with session folders generated by the [multicam.sh](https://github.com/JLMARIN/imaging/blob/master/multicam/multicam.sh). The naming convention of files is essential for the functioning of the programs. The program will detect the number of stacks.

ImageAlignment.java will align all the stacks individually, calculating the transformation matrix for each stack. ImageAlignmentPlus.java will open a second open dialog window asking for a transformation matrix file. If no file is given (click *Cancel*) the program will use the first stack to calculate the transformation matrices and with save them as a text file inside the given folder. Then it will align all the stacks using these transformation matrices.

The programs will run on each stack while briefly displaying it. A log window will also be displayed showing the progress of the program. The program will create a subfolder inside the images folder named "aligned", and aligned images will be saved inside using the same filenames.

### Examples

Example of 3 images before and after alignment:

Before Alignment           |  After Alignment
:-------------------------:|:-------------------------:
<img src="https://github.com/JLMARIN/imaging/blob/master/alignment/samples/raw.gif" width="400" height="300"> |  <img src="https://github.com/JLMARIN/imaging/blob/master/alignment/samples/aligned.gif" width="400" height="300">

## Known Issues

ImageJ comes bundled with a Java that is just a JRE (Java Runtime Environment) and not a full JDK. In some cases trying to run scripts gives an error about "javac.jar" not found.

On OSX and Unix, you can switch to using the system Java instead of the bundled one by navigating to your Fiji.app package (in the OSX Finder, right-click > *Show Package Contents*, in Unix go inside the Fiji.app folder) and renaming the `java` folder to something like `java-old`. Then restart Fiji and check you're running the right Java version by going to *Plugins > Utilities > ImageJ Properties*, which should report something like:

`java.home: /Library/Java/JavaVirtualMachines/jdk1.8.0_111.jdk/Contents/Home/jre`

Answer taken from: http://forum.imagej.net/t/no-javac-jar-found/2340/5 
